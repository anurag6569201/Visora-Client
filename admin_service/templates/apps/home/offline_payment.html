{% extends "account/base_entrance.html" %}
{% load i18n %}
{% load static %}
{% load allauth account %}

{% block head_title %}
    Offline Payment
{% endblock head_title %}

{% block stylesheet %}
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="{% static 'assets/css/login.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/loader.css' %}">
{% endblock stylesheet %}

{% block content %}
<div class="loader">
    <svg viewBox="0 0 240 240" height="240" width="240" class="pl">
        <circle
          stroke-linecap="round"
          stroke-dashoffset="-330"
          stroke-dasharray="0 660"
          stroke-width="20"
          stroke="#000"
          fill="none"
          r="105"
          cy="120"
          cx="120"
          class="pl__ring pl__ring--a"
        ></circle>
        <circle
          stroke-linecap="round"
          stroke-dashoffset="-110"
          stroke-dasharray="0 220"
          stroke-width="20"
          stroke="#000"
          fill="none"
          r="35"
          cy="120"
          cx="120"
          class="pl__ring pl__ring--b"
        ></circle>
        <circle
          stroke-linecap="round"
          stroke-dasharray="0 440"
          stroke-width="20"
          stroke="#000"
          fill="none"
          r="70"
          cy="120"
          cx="85"
          class="pl__ring pl__ring--c"
        ></circle>
        <circle
          stroke-linecap="round"
          stroke-dasharray="0 440"
          stroke-width="20"
          stroke="#000"
          fill="none"
          r="70"
          cy="120"
          cx="155"
          class="pl__ring pl__ring--d"
        ></circle>
      </svg>
</div>
<div class="login_container">
    <div style="border: 1px solid #cfd0d1;padding: 20px;border-radius: 35px;">
        <h2>Offline Payment for Order #{{ order_id }}</h2>
        <h2>Amount: {{ total_amount }}</h2>

        <!-- Confirm Order Button -->
        <button id="confirm-button" class="login_logging_btn mb-4">Confirm Order</button>
        <button id="cancel-button" class="login_logging_btn">Cancel Order</button>

        <!-- Countdown Timer -->
        <p id="countdown-timer">Time remaining: <span id="timer">120</span> seconds</p>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Set a 2-minute countdown (120 seconds)
        let timeRemaining = 120;
        const timerSpan = $('#timer');
        const confirmButton = $('#confirm-button');
        const cancelButton = $('#cancel-button');
        const orderId = "{{ order_id }}";
        console.log(orderId);
        function runloader() {
            const loader = document.querySelector('.loader');
            loader.style.display = 'flex';  // Show the loader
        }

        // Function to hide the loader
        function hideloader() {
            const loader = document.querySelector('.loader');
            loader.style.display = 'none';  // Hide the loader
        }

        // Start the countdown timer
        const countdownInterval = setInterval(function() {
            timeRemaining--;
            timerSpan.text(timeRemaining);

            if (timeRemaining <= 0) {
                clearInterval(countdownInterval);
                alert('Time expired! Redirecting to the cart.');
                window.location.href = "{% url 'home:view_cart' %}";
            }
        }, 1000);

        // Confirm Order action
        confirmButton.on('click', function() {
            runloader();
            $.ajax({
                url: `/confirm-order/${orderId}/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                success: function(data) {
                    hideloader();
                    if (data.success) {
                        window.location.href = "{% url 'home:past_orders' %}";
                    } else {
                        alert('Error: ' + data.error);
                    }
                },
                error: function(xhr, status, error) {
                    hideloader();
                    alert('An error occurred: ' + error);
                }
            });
        });

        // Cancel Order action
        cancelButton.on('click', function() {
            window.location.href = "{% url 'home:view_cart' %}";
        });
    </script>
</div>

{% endblock content %}
