{% extends "account/base_entrance.html" %}
{% load i18n %}
{% load static %}
{% load allauth account %}
{% block head_title %}
{% trans "Cart" %}
{% endblock head_title %}
{% block stylesheet %}
<link rel="stylesheet" href="{% static 'assets/css/cart.css' %}">
<style>

.navbar-brand img{
    width: 100px;
}
.login_logging_btn{
    background-color: #E9661D;
    border-radius: 25px;
    border: none;
    padding: 10px;
    color: white;
    width:8em;
}
.not_login_logging_btn{
    background-color: transparent;
    border: none;
    width:8em;
    text-decoration: underline;
}
.nav-link{
    border-bottom: 2px solid transparent;
}
.nav-link.active{
    border-bottom: 2px solid #E9661D;
}
/* Styling for cart item placeholders */
.img-placeholder {
    width: 70px;
    height: 70px;
    background-color: #e0e0e0;
    border-radius: 8px;
}

.quantity-selector .btn {
    padding: 0.5rem;
    font-size: 14px;
    width: 40px;
}

.cart-item {
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
}

.recommendation-item {
    background-color: #fff7f7;
    border-radius: 10px;
}

.cart-summary {
    border-top: 1px solid #ddd;
    padding-top: 15px;
    margin-top: 20px;
}

.btn-warning {
    background-color: #f69300;
    border: none;
}

.btn-close {
    border: none;
    background: none;
    font-size: 24px;
    cursor: pointer;
}
.btn-outline-primary {
    color: #E9661D;
    border-color: #E9661D;
}

.btn-outline-primary:hover {
    background-color: #E9661D;
    color: white;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
{% endblock stylesheet %}
{% block content %}
<div class="login_container">
    <div class="cart_page container">
        <div class="row mt-4">
            <div class="mb-3">
                <h3 style="border-bottom: 1px solid #ddd;display: flex;justify-content: space-between;">Your Cart <button onclick="window.location.href='{% url 'home:past_orders' %}'" class="btn btn-sm btn-outline-primary">Past Orders</button></h3>
            </div>
            <div id="cart_item_contain" class="card p-3" style="border: none;">
                {% if cart %}
                    <!-- Lunch Items Section -->
                    {% for item_name, item_data in cart.items %}
                        {% if item_data.meal_type == 'lunch' and item_data.quantity > 0 %}
                            <div class="cart-item d-flex justify-content-between align-items-center pb-4 mb-4" data-item="{{ item_name }}">
                                <div class="d-flex">
                                    <div class="img-placeholder me-3">
                                        {% if item_data.image_url %}
                                            <img loading="lazy" src="{{ item_data.image_url }}" alt="{{ item_name }}" style="width: 50px; height: 50px;">
                                        {% else %}
                                            <div class="img-placeholder" style="width: 50px; height: 50px; background-color: #e0e0e0;"></div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h5>{{ item_data.item_name }}</h5>
                                        <p class="item-price" data-id="{{ item_name }}">{{ item_data.price }}</p>
                                        <div class="input-group quantity-selector">
                                            <button class="btn btn-outline-secondary btn-minus" data-id="{{ item_name }}">-</button>
                                            <input type="hidden" name="meal_type" value="lunch">
                                            <input type="number" class="form-control text-center" value="{{ item_data.quantity }}" min="0" max="6" id="{{ item_name }}_qty">
                                            <button class="btn btn-outline-secondary btn-plus" data-id="{{ item_name }}">+</button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="item-total"><span>{{ item_data.total_price|floatformat:2 }}</span></h5>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}

                    <!-- Dinner Items Section -->
                    {% for item_name, item_data in cart.items %}
                        {% if item_data.meal_type == 'dinner' %}
                            <div class="cart-item d-flex justify-content-between align-items-center pb-4 mb-4" data-item="{{ item_name }}">
                                <div class="d-flex">
                                    <div class="img-placeholder me-3">
                                        {% if item_data.image_url %}
                                            <img loading="lazy" src="{{ item_data.image_url }}" alt="{{ item_name }}" style="width: 50px; height: 50px;">
                                        {% else %}
                                            <div class="img-placeholder" style="width: 50px; height: 50px; background-color: #e0e0e0;"></div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h5>{{ item_data.item_name }}</h5>
                                        <p class="item-price" data-id="{{ item_name }}">{{ item_data.price }} /-</p>
                                        <div class="input-group quantity-selector">
                                            <button class="btn btn-outline-secondary btn-minus" data-id="{{ item_name }}">-</button>
                                            <input type="hidden" name="meal_type" value="dinner">
                                            <input type="number" class="form-control text-center" value="{{ item_data.quantity }}" min="0" max="6" id="{{ item_name }}_qty">
                                            <button class="btn btn-outline-secondary btn-plus" data-id="{{ item_name }}">+</button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="item-total">{{ item_data.total_price|floatformat:2 }}</h5>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                
                <div id="lunchVegComboDiv" style="display:none;">
                    <div class="static_cart_item d-flex justify-content-between align-items-center pb-4 mb-4" data-item="Veg Roti + Rice Combo">
                        <div class="d-flex">
                            <div class="img-placeholder me-3">
                                <img loading="lazy" src="{% static 'assets/img/menu/vegcombo.webp' %}" alt="Veg Roti + Rice Combo" style="width: 50px; height: 50px;">
                            </div>
                            <div>
                                <h5>Veg Roti + Rice Combo</h5>
                                <p class="item-price">{{ today_veg_lunch_menu_price.price }} /-</p>
                            </div>
                        </div>
                        <div>
                            <h5 class="item-total">
                                <span id="lunchcart_veg_combo_total">{{ today_veg_lunch_menu_price.price }}</span> /-
                            </h5>
                        </div>
                    </div>
                </div>
                
                <div id="lunchVegRiceDiv" style="display:none;">
                    <div class="static_cart_item d-flex justify-content-between align-items-center pb-4 mb-4" data-item="Veg Only Rice Plate">
                        <div class="d-flex">
                            <div class="img-placeholder me-3">
                                <img loading="lazy" src="{% static 'assets/img/menu/vegrice.webp' %}" alt="Veg Only Rice Plate" style="width: 50px; height: 50px;">
                            </div>
                            <div>
                                <h5>Veg Only Rice Plate</h5>
                                <p class="item-price">{{ today_veg_lunch_menu_price.price }} /-</p>
                            </div>
                        </div>
                        <div>
                            <h5 class="item-total">
                                <span id="lunchcart_veg_rice_total">{{ today_veg_lunch_menu_price.price }}</span> /-
                            </h5>
                        </div>
                    </div>
                </div>
                
                <div id="lunchNonVegComboDiv" style="display:none;">
                    <div class="static_cart_item d-flex justify-content-between align-items-center pb-4 mb-4" data-item="Non-Veg Roti + Rice Combo">
                        <div class="d-flex">
                            <div class="img-placeholder me-3">
                                <img loading="lazy" src="{% static 'assets/img/menu/nonvegrotirice.webp' %}" alt="Non-Veg Roti + Rice Combo" style="width: 50px; height: 50px;">
                            </div>
                            <div>
                                <h5>Non-Veg Roti + Rice Combo</h5>
                                <p class="item-price">{{ today_nonveg_lunch_menu_price.price }} /-</p>
                            </div>
                        </div>
                        <div>
                            <h5 class="item-total">
                                <span id="lunchcart_nonveg_combo_total">{{ today_nonveg_lunch_menu_price.price }}</span> /-
                            </h5>
                        </div>
                    </div>
                </div>
                
                <div id="lunchNonVegRiceDiv" style="display:none;">
                    <div class="static_cart_item d-flex justify-content-between align-items-center pb-4 mb-4" data-item="Non-Veg Only Rice Plate">
                        <div class="d-flex">
                            <div class="img-placeholder me-3">
                                <img loading="lazy" src="{% static 'assets/img/menu/nonvegrice.webp' %}" alt="Non-Veg Only Rice Plate" style="width: 50px; height: 50px;">
                            </div>
                            <div>
                                <h5>Non-Veg Only Rice Plate</h5>
                                <p class="item-price">{{ today_nonveg_lunch_menu_price.price }} /-</p>
                            </div>
                        </div>
                        <div>
                            <h5 class="item-total">
                                <span id="lunchcart_nonveg_rice_total">{{ today_nonveg_lunch_menu_price.price }}</span> /-
                            </h5>
                        </div>
                    </div>
                </div>
                              
            
                <!-- Dinner Veg Roti+Rice Combo -->
                <div id="dinnerVegComboDiv" style="display:none;">
                    <div class="static_cart_item d-flex justify-content-between align-items-center pb-4 mb-4" data-item="Veg Roti+Rice Combo">
                        <div class="d-flex">
                            <div class="img-placeholder me-3">
                                <img loading="lazy" src="{% static 'assets/img/menu/vegcombo.webp' %}" alt="Veg Roti+Rice Combo" style="width: 50px; height: 50px;">
                            </div>
                            <div>
                                <h5>Veg Roti+Rice Combo</h5>
                                <p class="item-price">{{ today_veg_dinner_menu_price.price }} /-</p>
                            </div>
                        </div>
                        <div>
                            <h5 class="item-total">
                                <span id="dinnercart_veg_combo_total">{{ today_veg_dinner_menu_price.price }}</span> /-
                            </h5>
                        </div>
                    </div>
                </div>

                <!-- Dinner Veg Only Rice Plate -->
                <div id="dinnerVegRiceDiv" style="display:none;">
                    <div class="static_cart_item d-flex justify-content-between align-items-center pb-4 mb-4" data-item="Veg Only Rice Plate">
                        <div class="d-flex">
                            <div class="img-placeholder me-3">
                                <img loading="lazy" src="{% static 'assets/img/menu/vegrice.webp' %}" alt="Veg Only Rice Plate" style="width: 50px; height: 50px;">
                            </div>
                            <div>
                                <h5>Veg Only Rice Plate</h5>
                                <p class="item-price">{{ today_veg_dinner_menu_price.price }} /-</p>
                            </div>
                        </div>
                        <div>
                            <h5 class="item-total">
                                <span id="dinnercart_veg_rice_total">{{ today_veg_dinner_menu_price.price }}</span> /-
                            </h5>
                        </div>
                    </div>
                </div>

                <!-- Dinner Non-Veg Roti+Rice Combo -->
                <div id="dinnerNonVegComboDiv" style="display:none;">
                    <div class="static_cart_item d-flex justify-content-between align-items-center pb-4 mb-4" data-item="Non-Veg Roti+Rice Combo">
                        <div class="d-flex">
                            <div class="img-placeholder me-3">
                                <img loading="lazy" src="{% static 'assets/img/menu/nonvegrotirice.webp' %}" alt="Non-Veg Roti+Rice Combo" style="width: 50px; height: 50px;">
                            </div>
                            <div>
                                <h5>Non-Veg Roti+Rice Combo</h5>
                                <p class="item-price">{{ today_nonveg_dinner_menu_price.price }} /-</p>
                            </div>
                        </div>
                        <div>
                            <h5 class="item-total">
                                <span id="dinnercart_nonveg_combo_total">{{ today_nonveg_dinner_menu_price.price }}</span> /-
                            </h5>
                        </div>
                    </div>
                </div>

                <!-- Dinner Non-Veg Only Rice Plate -->
                <div id="dinnerNonVegRiceDiv" style="display:none;">
                    <div class="static_cart_item d-flex justify-content-between align-items-center pb-4 mb-4" data-item="Non-Veg Only Rice Plate">
                        <div class="d-flex">
                            <div class="img-placeholder me-3">
                                <img loading="lazy" src="{% static 'assets/img/menu/nonvegrice.webp' %}" alt="Non-Veg Only Rice Plate" style="width: 50px; height: 50px;">
                            </div>
                            <div>
                                <h5>Non-Veg Only Rice Plate</h5>
                                <p class="item-price">{{ today_nonveg_dinner_menu_price.price }} /-</p>
                            </div>
                        </div>
                        <div>
                            <h5 class="item-total">
                                <span id="dinnercart_nonveg_rice_total">{{ today_nonveg_dinner_menu_price.price }}</span> /-
                            </h5>
                        </div>
                    </div>
                </div>

                <div class="cart_address">
                    {% if user.is_authenticated %}
                        {% for address in addresses %}
                            <li style="list-style: none;">
                                <strong>Delivery Address : </strong>{{ address.address_line1 }}, {{ address.city }}, {{ address.phone_number }}
                            </li>
                        {% empty %}
                            <li>No delivery addresses added yet.</li>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Summary -->
                <div class="cart-summary">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal (<span id="item-count">{{ cart|length }}</span> Items)</span>
                        <span id="subtotal">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping Fee</span>
                        <span id="shipping-fee">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Total</strong>
                        <strong id="total">0</strong>
                    </div>
                </div>
            </div>

            <!-- Bootstrap Modal -->
            <div class="modal fade" id="paymentModal" tabindex="1" aria-labelledby="paymentModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Select Payment Method</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                    <p>Choose your preferred payment method:</p>
                    <div style="display: flex;justify-content: left;flex-direction: column;gap: 10px;">
                        <button type="button" class="login_logging_btn" style="width: 200px;" id="cashOnDelivery">Cash on Delivery</button>
                        <button type="button" class="login_logging_btn" style="width: 200px;opacity: 0.7;pointer-events: none;" id="paymentOnDelivery">Online Payment</button>
                    </div>
                    </div>
                    <div class="modal-footer">
                    <button type="button" class="login_logging_btn" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
                </div>
            </div>

            <div class="p-2">
                {% if user.is_authenticated %}
                    {% if addresses %}
                        {% if email_verified %}
                            <button id="rzp-button1" class="login_logging_btn razorpay_btn mt-3" style="display: flex;width: 100%;text-decoration: none;justify-content: center;">
                                <a style="text-decoration: none;">Place Order</a>
                            </button>
                        {% else %}
                            <button onclick="window.location.href='{% url 'account_email' %}'" class="login_logging_btn razorpay_btn mt-3" style="display: flex;width: 100%;text-decoration: none;justify-content: center;">
                                <a style="text-decoration: none;">Please Verify Your Email</a>
                            </button>
                        {% endif %}
                    {% else %}
                    <a href="{% url 'home:user_profile' %}" class="login_logging_btn razorpay_btn mt-3" style="display: flex;width: 100%;text-decoration: none;justify-content: center;">Add an Primary Address</a>
                    {% endif %}
                {% else %}
                    <a href="{% url 'account_login' %}" class="login_logging_btn razorpay_btn mt-3" style="display: flex;width: 100%;text-decoration: none;justify-content: center;">Log in to place order</a>
                {% endif %}
            </div>
        </div>
        <br><br><br>
    </div>

    
    <script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"></script>
    <script>
    $(document).ready(function() {
        $('#rzp-button1').on('click', function(event) {
            event.preventDefault(); // Prevent the default anchor click behavior
            $('#paymentModal').modal('show'); // Show the modal
        });

        $('#cashOnDelivery').on('click', function() {
            this.window.location.href="{% url 'home:offline_payment' %}"
            $('#paymentModal').modal('hide'); // Hide the modal
        });
    });

    </script>
    <script>
    $(document).ready(function() {
    var lunchVegComboQty = sessionStorage.getItem('lunchveg_combo_qty') || 0;
    var lunchVegRiceQty = sessionStorage.getItem('lunchveg_rice_qty') || 0;
    var lunchNonVegComboQty = sessionStorage.getItem('lunchnonveg_combo_qty') || 0;
    var lunchNonVegRiceQty = sessionStorage.getItem('lunchnonveg_rice_qty') || 0;

    var dinnerVegComboQty = sessionStorage.getItem('dinnerveg_combo_qty') || 0;
    var dinnerVegRiceQty = sessionStorage.getItem('dinnerveg_rice_qty') || 0;
    var dinnerNonVegComboQty = sessionStorage.getItem('dinnernonveg_combo_qty') || 0;
    var dinnerNonVegRiceQty = sessionStorage.getItem('dinnernonveg_rice_qty') || 0;


    var todayVegLunchPrice = {{ today_veg_lunch_menu_price.price }};
    var todayNonVegLunchPrice = {{ today_nonveg_lunch_menu_price.price }};
    var todayVegDinnerPrice = {{ today_veg_dinner_menu_price.price }};
    var todayNonVegDinnerPrice = {{ today_nonveg_dinner_menu_price.price }};

    // Update the total price for each meal
    $('#lunchcart_nonveg_combo_total').text((lunchNonVegComboQty * todayNonVegLunchPrice).toFixed(2));
    $('#lunchcart_nonveg_rice_total').text((lunchNonVegRiceQty * todayNonVegLunchPrice).toFixed(2));
    $('#lunchcart_veg_rice_total').text((lunchVegRiceQty * todayVegLunchPrice).toFixed(2));
    $('#lunchcart_veg_combo_total').text((lunchVegComboQty * todayVegLunchPrice).toFixed(2));

    $('#dinnercart_nonveg_combo_total').text((dinnerNonVegComboQty * todayNonVegDinnerPrice).toFixed(2));
    $('#dinnercart_nonveg_rice_total').text((dinnerNonVegRiceQty * todayNonVegDinnerPrice).toFixed(2));
    $('#dinnercart_veg_rice_total').text((dinnerVegRiceQty * todayVegDinnerPrice).toFixed(2));
    $('#dinnercart_veg_combo_total').text((dinnerVegComboQty * todayVegDinnerPrice).toFixed(2));

    if (lunchVegComboQty > 0) {
    $('#lunchVegComboDiv').show();
    }
    if (lunchVegRiceQty > 0) {
        $('#lunchVegRiceDiv').show();
    }
    if (lunchNonVegComboQty > 0) {
        $('#lunchNonVegComboDiv').show();
    }
    if (lunchNonVegRiceQty > 0) {
        $('#lunchNonVegRiceDiv').show();
    }
    if (dinnerVegComboQty > 0) {
    $('#dinnerVegComboDiv').show();
    }
    if (dinnerVegRiceQty > 0) {
        $('#dinnerVegRiceDiv').show();
    }
    if (dinnerNonVegComboQty > 0) {
        $('#dinnerNonVegComboDiv').show();
    }
    if (dinnerNonVegRiceQty > 0) {
        $('#dinnerNonVegRiceDiv').show();
    }
        // Calculate and update subtotal
        function updateSubtotal() {
            let subtotal = 0;
            $('.item-total').each(function() {
                subtotal += parseFloat($(this).text());
            });
            $('#subtotal').text(subtotal.toFixed(2));
            $('#total').text(subtotal.toFixed(2)); // Assuming no additional charges
        }
    
        // Event listener to update quantity
        $('.btn-plus, .btn-minus').click(function() {
            let itemId = $(this).data('id');
            let inputField = $('#' + itemId + '_qty');
            let currentQty = parseInt(inputField.val());
            let newQty = $(this).hasClass('btn-plus') ? currentQty  : currentQty ;
            if (newQty < 0) newQty = 0; // Prevent negative values

            inputField.val(newQty);
            updateSubtotal();
            calculateAndSendTotal();
        });
    
        updateSubtotal();
    });
    function updateCartSummary() {
        let subtotal = 0;
        
        document.querySelectorAll('.cart-item').forEach(item => {
            const quantity = parseInt(item.querySelector('input[type="number"]').value);
            const price = parseFloat(item.querySelector('.item-price').textContent);
            const itemTotal = quantity * price;

            item.querySelector('.item-total').textContent = itemTotal.toFixed(2);
            subtotal += itemTotal;
        });

        const shippingFee = 0; // Change this if needed
        const total = subtotal + shippingFee;

        document.getElementById('subtotal').textContent = subtotal.toFixed(2);
        document.getElementById('shipping-fee').textContent = shippingFee.toFixed(2);
        document.getElementById('total').textContent = total.toFixed(2);
    }
    document.querySelectorAll('.btn-minus').forEach(button => {
    button.addEventListener('click', function() {
        const itemId = this.getAttribute('data-id');
        const inputField = document.getElementById(itemId + '_qty');
        const priceElement = document.querySelector(`.item-price[data-id="${itemId}"]`);
        const price = parseFloat(priceElement.textContent); // Get price for the item
        let quantity = parseInt(inputField.value);
        console.log("Before decrement:", quantity, price);

        if (quantity > 0) {
            quantity -= 1;
            inputField.value = quantity;
            let mealType = inputField.closest('.quantity-selector').querySelector('input[name="meal_type"]').value; // Return "lunch" or "dinner"
            let combinedId = itemId;
            console.log("Updated quantity:", quantity, "Meal Type:", mealType);

            const itemTotal = (quantity) * price; // Calculate total for the item
            console.log("Item Total:", itemTotal);

            if (itemTotal < 1) {
                sessionStorage.removeItem(itemId);
                $.ajax({
                    type: 'POST',
                    url: '/remove_from_cart/',  
                    data: {
                        'item_name': itemId, 
                        'csrfmiddlewaretoken': '{{ csrf_token }}' 
                    },
                    success: function(response) {
                        console.log('Item removed from cart', response);
                        const cartItem = document.querySelector(`[data-item="${itemId}"]`);
                        if (cartItem) {
                                cartItem.remove();  // Remove the item completely from the DOM
                            }
                        },
                    error: function(error) {
                        console.error('Error removing item from cart', error);
                    }
                });

                // Hide the item if quantity is 0 or less
                const cartItem = document.querySelector(`[data-item="${itemId}"]`);
                console.log("Cart Item:", cartItem);

                if (cartItem) {
                    // Hide the entire cart item container
                    cartItem.style.display = 'none';
                    console.log("Cart item hidden");
                } else {
                    console.log("Cart item not found with data-item:", itemId);
                }
            } else {
                const itemData = { id: itemId, quantity: quantity, price: price };
                sessionStorage.setItem(itemId, JSON.stringify(itemData)); 
            }

            updateCartSummary();
            calculateAndSendTotal();
        }
    });
});


document.querySelectorAll('.btn-plus').forEach(button => {
    button.addEventListener('click', function() {
        const itemId = this.getAttribute('data-id');
        const inputField = document.getElementById(itemId + '_qty');
        const priceElement = document.querySelector(`.item-price[data-id="${itemId}"]`);
        const price = parseFloat(priceElement.textContent); 
        let quantity = parseInt(inputField.value);

        quantity += 1;
        inputField.value = quantity;

        const itemData = { id: itemId, quantity: quantity, price: price };
        sessionStorage.setItem(itemId, JSON.stringify(itemData));

        updateCartSummary();
        calculateAndSendTotal();
    });
});

function calculateAndSendTotal() {
    var totalSum = 0;

    $('.item-total').each(function() {
        var itemTotal = parseFloat($(this).text()) || 0;
        totalSum += itemTotal;
    });

    if (totalSum === 0) {
        $('.razorpay_btn').prop('disabled', true).css('opacity', '0.6');
    } else {
        $('.razorpay_btn').prop('disabled', false).css('opacity', '1');
    }

    $.ajax({
        url: '{% url "home:checkout" %}', 
        method: 'POST',
        data: { total: totalSum },
        error: function(xhr, status, error) {
            console.error('Error sending total:', error);
        }
    });
}

function populateCartFromStorage() {
    for (let i = 0; i < sessionStorage.length; i++) {
        const itemId = sessionStorage.key(i);
        let itemData;

        try {
            itemData = JSON.parse(sessionStorage.getItem(itemId));
        } catch (error) {
            console.warn(`Invalid JSON for item ${itemId}:`, error);
            continue;  // Skip this entry if JSON parsing fails
        }

        if (itemData && itemData.id && itemData.quantity && itemData.price) {
            const inputField = document.getElementById(itemData.id + '_qty');
            const priceElement = document.querySelector(`.item-price[data-id="${itemData.id}"]`);

            if (inputField && priceElement) {
                inputField.value = itemData.quantity;

                updateCartSummary();
                calculateAndSendTotal();
            }
        }
    }
}

populateCartFromStorage();


        </script>
    
<script>
    // calculateAndSendTotal();
    // generateAndSavePDF()
    document.getElementById('paymentOnDelivery').onclick = function (e) {
        $('#paymentModal').modal('hide');
    }

    document.getElementById('cashOnDelivery').onclick = function (e) {
        $('#paymentModal').modal('hide');
        calculateAndSendTotal();
        generateAndSavePDFoffline()
    }


    const { jsPDF } = window.jspdf;

    function generateAndSavePDFoffline() {
    var element = document.getElementById('cart_item_contain');

    if (!element) {
        alert("Element with id 'cart_item_contain' not found!");
        return;
    }

    // Reduce scale for better performance and lower file size
    html2canvas(element, { scale: 1 }).then(canvas => {
        var imgData = canvas.toDataURL('image/jpeg', 0.7); // JPEG format and compression quality set to 70%
        var pdf = new jsPDF('p', 'mm', 'a4');

        // Defined dimensions for A4 page
        var pageWidth = pdf.internal.pageSize.getWidth();
        var pageHeight = pdf.internal.pageSize.getHeight();
        var imgHeight = canvas.height * (pageWidth / canvas.width); // Image height based on aspect ratio

        // Add image to the first page
        pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, imgHeight);

        // Check if the image height exceeds the page height
        var totalPages = Math.ceil(imgHeight / pageHeight);
        for (var i = 1; i < totalPages; i++) {
            pdf.addPage();
            var yOffset = -pageHeight * i;
            pdf.addImage(imgData, 'JPEG', 0, yOffset, pageWidth, imgHeight);
        }

        var formData = new FormData();
        var pdfBlob = pdf.output('blob');
        formData.append('pdf', pdfBlob, 'invoice.pdf');
        formData.append('customer_email', "{{ request.user.email }}");

        fetch('/save-pdf/offline/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        }).then(response => {
            if (!response.ok) {
                console.error('Network response was not ok:', response.statusText);
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Response:', data);
            if (data.success) {
                window.location.href = '/offline-payment/';
            } else {
                console.error('Error saving the order:', data.error);
                alert('Error saving the order: ' + data.error);
            }
        }).catch(error => {
            console.error("Error:", error);
            alert("An error occurred: " + error.message);
        });
    }).catch(error => {
        console.error("Error generating PDF:", error);
        alert("Error generating PDF.");
    });
}
function generateAndSavePDF() {
    var element = document.getElementById('cart_item_contain');

    if (!element) {
        alert("Element with id 'cart_item_contain' not found!");
        return;
    }

    // Reduce scale for better performance and lower file size
    html2canvas(element, { scale: 1 }).then(canvas => {
        var imgData = canvas.toDataURL('image/jpeg', 0.7); // JPEG format and compression quality set to 70%
        var pdf = new jsPDF('p', 'mm', 'a4');

        // Defined dimensions for A4 page
        var pageWidth = pdf.internal.pageSize.getWidth();
        var pageHeight = pdf.internal.pageSize.getHeight();
        var imgHeight = canvas.height * (pageWidth / canvas.width); // Image height based on aspect ratio

        // Add image to the first page
        pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, imgHeight);

        // Check if the image height exceeds the page height
        var totalPages = Math.ceil(imgHeight / pageHeight);
        for (var i = 1; i < totalPages; i++) {
            pdf.addPage();
            var yOffset = -pageHeight * i;
            pdf.addImage(imgData, 'JPEG', 0, yOffset, pageWidth, imgHeight);
        }

        var formData = new FormData();
        var pdfBlob = pdf.output('blob');
        formData.append('pdf', pdfBlob, 'invoice.pdf');
        formData.append('customer_email', "{{ request.user.email }}");

        fetch('/save-pdf/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        }).then(response => {
            if (!response.ok) {
                console.error('Network response was not ok:', response.statusText);
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Response:', data);
            if (data.success) {
                window.location.href = '/razorpay/';
            } else {
                console.error('Error saving the order:', data.error);
                alert('Error saving the order: ' + data.error);
            }
        }).catch(error => {
            console.error("Error:", error);
            alert("An error occurred: " + error.message);
        });
    }).catch(error => {
        console.error("Error generating PDF:", error);
        alert("Error generating PDF.");
    });
}

const totalElement = document.getElementById("total");
const totalValue = parseFloat(totalElement.textContent);  // Get the total value
const orderButton = document.getElementById("rzp-button1");

if (totalValue === 0) {
    // Apply styles if total is zero
    orderButton.style.pointerEvents = "none";
    orderButton.style.opacity = "0.6";
} else {
    // Remove the styles if total is not zero
    orderButton.style.pointerEvents = "auto";
    orderButton.style.opacity = "1";
}
</script>




</div>
{% endblock content %}
